---
title: 层级 3: 标准工作流
description: 标准规划工作流 - 完整规划和 TDD 开发
sidebar_position: 4
---

import Mermaid from '@theme/Mermaid';

# 层级 3: 标准工作流

**复杂度**: 中-高 | **产物**: 持久化会话文件 | **状态**: 完全会话管理

层级 3 工作流提供完整规划并支持持久化会话管理。专为需要可追溯性、验证和结构化执行的多模块变更而设计。

## 概述

<Mermaid
  chart={`
    flowchart TD
        Start([用户输入]) --> Select{选择工作流}

        Select -->|标准<br/>开发| Plan[plan]
        Select -->|测试驱动| TDD[tdd-plan]
        Select -->|测试修复| TestFix[test-fix-gen]

        Plan --> Verify[plan-verify<br/>可选]
        TDD --> Verify
        Verify --> Execute[execute]

        TestFix --> TestCycle[test-cycle-execute]

        Execute --> Review{需要审查?}
        TestCycle --> Review

        Review -->|是| RevCycle[review-session-cycle]
        Review -->|否| TestQ{有测试?}
        RevCycle --> RevFix[review-cycle-fix]
        RevFix --> TestQ

        TestQ -->|是| TFG[test-fix-gen]
        TestQ -->|否| Complete([session:complete])

        TFG --> TCE[test-cycle-execute]
        TCE --> Complete

        classDef startend fill:#c8e6c9,stroke:#388e3c
        classDef workflow fill:#e3f2fd,stroke:#1976d2
        classDef decision fill:#fff9c4,stroke:#f57c00
        classDef execute fill:#c5e1a5,stroke:#388e3c

        class Start,Complete startend,Select,Review,TestQ decision,Plan,TDD,TestFix workflow,Verify,Execute,TestCycle,RevCycle,RevFix,TFG,TCE execute
  `}
/>

## 包含的工作流

| 工作流 | 用途 | 阶段数 | 产物位置 |
|----------|---------|--------|-------------------|
| `plan` | 复杂功能开发 | 5 阶段 | `.workflow/active/{session}/` |
| `tdd-plan` | 测试驱动开发 | 6 阶段 | `.workflow/active/{session}/` |
| `test-fix-gen` | 测试修复生成 | 5 阶段 | `.workflow/active/WFS-test-{session}/` |

### 共同特性

| 属性 | 值 |
|----------|-------|
| **复杂度** | 中-高 |
| **产物** | 持久化文件 (`.workflow/active/{session}/`) |
| **状态** | 完全会话管理 |
| **验证** | 内置验证步骤 |
| **执行** | `/workflow:execute` |
| **适用场景** | 多模块、可追溯任务 |

---

## 工作流 1: plan -> verify -> execute

**5 阶段完整规划工作流**

### 命令

```bash
/workflow:plan "实现 OAuth2 认证系统"
/workflow:plan-verify  # 验证计划（推荐）
/workflow:execute
/workflow:review  # (可选) 代码审查
```

### 流程图

<Mermaid
  chart={`
    flowchart TD
        A([开始]) --> B[阶段 1: 会话发现]
        B --> C[/workflow:session:start<br/>--auto/]
        C --> D[返回: sessionId]

        D --> E[阶段 2: 上下文收集]
        E --> F[/workflow:tools:context-gather/]
        F --> G[返回: context-package.json<br/>+ conflict_risk]

        G --> H{conflict_risk<br/>>= medium?}
        H -->|是| I[阶段 3: 冲突解决]
        H -->|否| J[阶段 4: 任务生成]
        I --> K[/workflow:tools:conflict<br/>-resolution/]
        K --> J

        J --> L[/workflow:tools:task-generate<br/>-agent/]
        L --> M[返回: IMPL_PLAN.md<br/>+ IMPL-*.json<br/>+ TODO_LIST.md]

        M --> N[返回摘要<br/>+ 下一步]
        N --> O([规划完成])

        classDef startend fill:#c8e6c9,stroke:#388e3c
        classDef action fill:#e3f2fd,stroke:#1976d2
        classDef decision fill:#fff9c4,stroke:#f57c00
        classDef tool fill:#ffecb3,stroke:#ffa000

        class A,O startend,H decision,B,E,G,J,M,N action,C,F,K,L tool
  `}
/>

### 流程阶段

**阶段 1: 会话发现**
```bash
/workflow:session:start --auto "实现 OAuth2 认证系统"
```
- 创建或发现工作流会话
- 返回: `sessionId`

**阶段 2: 上下文收集**
```bash
/workflow:tools:context-gather
```
- 分析代码库结构
- 识别技术栈和模式
- 返回: `context-package.json` + `conflict_risk`

**阶段 3: 冲突解决**（条件触发）
```bash
# 仅当 conflict_risk >= medium 时
/workflow:tools:conflict-resolution
```
- 检测潜在冲突
- 解决依赖问题
- 确保清晰的执行路径

**阶段 4: 任务生成**
```bash
/workflow:tools:task-generate-agent
```
- 生成结构化任务
- 创建依赖图
- 返回: `IMPL_PLAN.md` + `IMPL-*.json` + `TODO_LIST.md`

### 产物

**位置**: `.workflow/active/{WFS-session}/`

```
.workflow/active/WFS-oauth2-auth-2025-02-03/
├── workflow-session.json          # 会话元数据
├── IMPL_PLAN.md                   # 实现计划
├── TODO_LIST.md                   # 进度跟踪
├── .task/
│   ├── IMPL-001.json              # 主任务
│   ├── IMPL-002.json
│   └── ...
└── .process/
    ├── context-package.json       # 项目上下文
    ├── conflict-resolution.json   # 冲突分析
    └── planning-notes.md
```

### 适用场景

- 多模块变更
- 代码重构
- 需要依赖分析

---

## 工作流 2: tdd-plan -> execute -> tdd-verify

**6 阶段测试驱动开发工作流**

### 命令

```bash
/workflow:tdd-plan "使用 TDD 实现用户注册"
/workflow:execute  # 遵循 Red-Green-Refactor
/workflow:tdd-verify  # 验证 TDD 合规性
```

### 流程图

<Mermaid
  chart={`
    flowchart TD
        A([开始]) --> B[阶段 1: 会话发现]
        B --> C[/workflow:session:start<br/>--type tdd --auto/]
        C --> D[解析: sessionId]

        D --> E[阶段 2: 上下文收集]
        E --> F[/workflow:tools:context-gather/]
        F --> G[返回: context-package.json]

        G --> H[阶段 3: 测试覆盖率分析]
        H --> I[/workflow:tools:test-context<br/>-gather/]
        I --> J[检测测试框架<br/>分析覆盖率]

        J --> K{conflict_risk<br/>>= medium?}
        K -->|是| L[阶段 4: 冲突解决]
        K -->|否| M[阶段 5: TDD 任务生成]
        L --> N[/workflow:tools:conflict<br/>-resolution/]
        N --> M

        M --> O[/workflow:tools:task-generate<br/>-tdd/]
        O --> P[生成包含 Red-Green-<br/>Refactor 循环的 IMPL 任务]

        P --> Q[阶段 6: TDD 结构验证]
        Q --> R[验证 TDD 合规性]

        R --> S([TDD 规划完成])

        T[执行] --> U[/workflow:execute/]
        U --> V[遵循每个任务中的<br/>Red-Green-Refactor 循环]

        V --> W[验证]
        W --> X[/workflow:tdd-verify/]
        X --> Y([完成])

        classDef startend fill:#c8e6c9,stroke:#388e3c
        classDef action fill:#e3f2fd,stroke:#1976d2
        classDef decision fill:#fff9c4,stroke:#f57c00
        classDef tool fill:#ffecb3,stroke:#ffa000

        class A,S,Y startend,K decision,B,E,G,H,J,M,P,Q,R,T,U,V,X action,C,F,I,N,O,W tool
  `}
/>

### 流程阶段

**阶段 1: 会话发现**
```bash
/workflow:session:start --type tdd --auto "TDD: 用户注册"
```

**TDD 结构化格式**:
```
TDD: [功能名称]
GOAL: [目标]
SCOPE: [包含/排除的范围]
CONTEXT: [背景]
TEST_FOCUS: [测试场景]
```

**阶段 2: 上下文收集**
```bash
/workflow:tools:context-gather
```

**阶段 3: 测试覆盖率分析**
```bash
/workflow:tools:test-context-gather
```
- 检测测试框架
- 分析现有测试覆盖率
- 识别覆盖率缺口

**阶段 4: 冲突解决**（条件触发）
```bash
# 仅当 conflict_risk >= medium 时
/workflow:tools:conflict-resolution
```

**阶段 5: TDD 任务生成**
```bash
/workflow:tools:task-generate-tdd
```
- 生成包含内置 Red-Green-Refactor 循环的 IMPL 任务
- `meta.tdd_workflow: true`
- `flow_control.implementation_approach` 包含 3 个步骤（red/green/refactor）

**阶段 6: TDD 结构验证**
- 验证 TDD 结构合规性

### TDD 任务结构

```json
{
  "id": "IMPL-001",
  "title": "实现用户注册",
  "meta": {
    "tdd_workflow": true
  },
  "flow_control": {
    "implementation_approach": [
      {
        "step": 1,
        "title": "Red: 编写失败的测试",
        "description": "编写一个失败的测试"
      },
      {
        "step": 2,
        "title": "Green: 使测试通过",
        "description": "实现最小代码使测试通过",
        "test_fix_cycle": {
          "max_iterations": 3,
          "pass_threshold": 0.95
        }
      },
      {
        "step": 3,
        "title": "Refactor: 改进代码",
        "description": "在保持测试通过的同时重构"
      }
    ]
  }
}
```

### 铁律

```
没有失败的测试，就没有生产代码
```

**执行方法**:
- 阶段 5: `implementation_approach` 包含测试优先步骤（Red -> Green -> Refactor）
- Green 阶段: 包含 test-fix-cycle 配置（最多 3 次迭代）
- 自动回滚: 达到最大迭代次数且测试未通过时触发

**顺序为何重要**:
- 后写的测试会立即通过 -> 证明不了什么
- 测试优先强制在实现前发现边界情况
- 后写测试验证的是已构建的内容，而非所需内容

### 适用场景

- 测试驱动开发
- 高质量功能需求
- 关键系统组件

---

## 工作流 3: test-fix-gen -> test-cycle-execute

**5 阶段测试修复生成工作流**

### 命令

```bash
# 会话模式
/workflow:test-fix-gen WFS-user-auth-v2
/workflow:test-cycle-execute

# 提示词模式
/workflow:test-fix-gen "测试认证 API"
/workflow:test-cycle-execute
```

### 流程图

<Mermaid
  chart={`
    flowchart TD
        A([开始]) --> B{输入模式?}

        B -->|会话<br/>模式| C[阶段 1: 使用源<br/>会话]
        B -->|提示词<br/>模式| D[阶段 1: 创建<br/>测试会话]

        C --> E[/workflow:session:start<br/>--type test --resume/]
        D --> F[/workflow:session:start<br/>--type test --new/]

        E --> G[阶段 2: 收集测试上下文]
        F --> H[阶段 2: 收集测试上下文]

        G --> I[/workflow:tools:test-context<br/>-gather/]
        H --> I

        I --> J[阶段 3: 测试生成分析]
        J --> K[/workflow:tools:test-concept<br/>-enhanced/]
        K --> L[多层测试需求<br/>L0: 静态, L1: 单元<br/>L2: 集成, L3: E2E]

        L --> M[阶段 4: 生成测试任务]
        M --> N[/workflow:tools:test-task-generate/]
        N --> O[IMPL-001: 生成<br/>+ IMPL-001.5: 质量门<br/>+ IMPL-002: 执行修复]

        O --> P[阶段 5: 返回摘要]
        P --> Q[-> test-cycle-execute]

        Q --> R([测试修复完成])

        classDef startend fill:#c8e6c9,stroke:#388e3c
        classDef action fill:#e3f2fd,stroke:#1976d2
        classDef decision fill:#fff9c4,stroke:#f57c00
        classDef tool fill:#ffecb3,stroke:#ffa000

        class A,R startend,B decision,C,D,E,F,G,H,J,M,P,Q action,I,K,N tool
  `}
/>

### 流程阶段

**阶段 1: 创建/使用测试会话**

**会话模式**（使用现有会话）:
```bash
/workflow:session:start --type test --resume WFS-user-auth-v2
```

**提示词模式**（创建新会话）:
```bash
/workflow:session:start --type test --new
```

**阶段 2: 收集测试上下文**
```bash
/workflow:tools:test-context-gather
```

**阶段 3: 测试生成分析**
```bash
/workflow:tools:test-concept-enhanced
```
- 多层测试需求:
  - **L0: 静态** - 类型检查、代码检查
  - **L1: 单元** - 函数级测试
  - **L2: 集成** - 组件交互测试
  - **L3: E2E** - 完整系统测试

**阶段 4: 生成测试任务**
```bash
/workflow:tools:test-task-generate
```
- `IMPL-001.json`: 测试理解与生成
- `IMPL-001.5-review.json`: 质量门
- `IMPL-002.json`: 测试执行与修复循环

**阶段 5: 返回摘要**
- -> `/workflow:test-cycle-execute`

### 双模式支持

| 模式 | 输入模式 | 上下文来源 |
|------|---------------|----------------|
| **会话模式** | `WFS-xxx` | 源会话摘要 |
| **提示词模式** | 文本/文件路径 | 直接代码库分析 |

### 产物

**位置**: `.workflow/active/WFS-test-{session}/`

```
.workflow/active/WFS-test-user-auth-2025-02-03/
├── workflow-session.json
├── .task/
│   ├── IMPL-001.json              # 测试理解与生成
│   ├── IMPL-001.5-review.json     # 质量门
│   └── IMPL-002.json              # 测试执行与修复循环
└── .process/
    ├── TEST_ANALYSIS_RESULTS.md
    └── test-context-package.json
```

### 适用场景

- 测试失败修复
- 覆盖率提升
- 测试套件生成

---

## 层级 3 对比表

| 方面 | plan | tdd-plan | test-fix-gen |
|--------|------|----------|--------------|
| **用途** | 复杂功能 | 测试驱动开发 | 测试修复 |
| **阶段** | 5 | 6 | 5 |
| **TDD** | 否 | 是 (Red-Green-Refactor) | 可选 |
| **产物** | `.workflow/active/` | `.workflow/active/` | `.workflow/active/WFS-test-*/` |
| **验证** | plan-verify | tdd-verify | 内置质量门 |
| **最适合** | 多模块变更 | 高质量功能 | 测试改进 |

## 执行: execute

所有层级 3 工作流通过 `execute` 执行:

```bash
/workflow:execute --session WFS-{session-id}
```

### 关键特性

- **依赖分析** - 自动任务依赖解析
- **并行执行** - 独立任务并行运行
- **进度跟踪** - 基于会话的 TODO 更新
- **摘要** - 为依赖任务生成任务完成摘要

## 相关工作流

- [层级 2: 快速](./level-2-rapid.mdx) - 更简单的工作流
- [层级 4: 头脑风暴](./level-4-brainstorm.mdx) - 多角色探索
- [层级 5: 智能](./level-5-intelligent.mdx) - 自动化编排
- [常见问题](./faq.mdx) - 常见问题解答
