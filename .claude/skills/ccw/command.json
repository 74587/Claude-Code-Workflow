{
  "_metadata": {
    "version": "2.0.0",
    "description": "Unified CCW command index with capabilities, flows, and intent rules"
  },

  "capabilities": {
    "explore": {
      "description": "Codebase exploration and context gathering",
      "commands": ["/workflow:init", "/workflow:tools:gather", "/memory:load"],
      "agents": ["cli-explore-agent", "context-search-agent"]
    },
    "brainstorm": {
      "description": "Multi-perspective analysis and ideation",
      "commands": ["/workflow:brainstorm:auto-parallel", "/workflow:brainstorm:artifacts", "/workflow:brainstorm:synthesis"],
      "roles": ["product-manager", "system-architect", "ux-expert", "data-architect", "api-designer"]
    },
    "plan": {
      "description": "Task planning and decomposition",
      "commands": ["/workflow:lite-plan", "/workflow:plan", "/workflow:tdd-plan", "/task:create", "/task:breakdown"],
      "agents": ["cli-lite-planning-agent", "action-planning-agent"]
    },
    "verify": {
      "description": "Plan and quality verification",
      "commands": ["/workflow:action-plan-verify", "/workflow:tdd-verify"]
    },
    "execute": {
      "description": "Task execution and implementation",
      "commands": ["/workflow:lite-execute", "/workflow:execute", "/task:execute"],
      "agents": ["code-developer", "cli-execution-agent", "universal-executor"]
    },
    "bugfix": {
      "description": "Bug diagnosis and fixing",
      "commands": ["/workflow:lite-fix"],
      "agents": ["code-developer"]
    },
    "test": {
      "description": "Test generation and execution",
      "commands": ["/workflow:test-gen", "/workflow:test-fix-gen", "/workflow:test-cycle-execute"],
      "agents": ["test-fix-agent"]
    },
    "review": {
      "description": "Code review and quality analysis",
      "commands": ["/workflow:review-session-cycle", "/workflow:review-module-cycle", "/workflow:review", "/workflow:review-fix"]
    },
    "issue": {
      "description": "Issue lifecycle management - discover, accumulate, batch resolve",
      "commands": ["/issue:new", "/issue:discover", "/issue:discover-by-prompt", "/issue:plan", "/issue:queue", "/issue:execute", "/issue:manage"],
      "agents": ["issue-plan-agent", "issue-queue-agent", "cli-explore-agent"],
      "lifecycle": {
        "accumulation": {
          "description": "任务完成后进行需求扩展、bug分析、测试发现",
          "triggers": ["post-task review", "code review findings", "test failures"],
          "commands": ["/issue:discover", "/issue:discover-by-prompt", "/issue:new"]
        },
        "batch_resolution": {
          "description": "积累的issue集中规划和并行执行",
          "flow": ["plan", "queue", "execute"],
          "commands": ["/issue:plan --all-pending", "/issue:queue", "/issue:execute"]
        }
      }
    },
    "ui-design": {
      "description": "UI design and prototyping",
      "commands": ["/workflow:ui-design:explore-auto", "/workflow:ui-design:imitate-auto", "/workflow:ui-design:design-sync"],
      "agents": ["ui-design-agent"]
    },
    "memory": {
      "description": "Documentation and knowledge management",
      "commands": ["/memory:docs", "/memory:update-related", "/memory:update-full", "/memory:skill-memory"],
      "agents": ["doc-generator", "memory-bridge"]
    }
  },

  "flows": {
    "rapid": {
      "name": "Rapid Iteration",
      "description": "多模型协作分析 + 直接执行",
      "complexity": ["low", "medium"],
      "steps": [
        { "command": "/workflow:lite-plan", "optional": false, "auto_continue": true },
        { "command": "/workflow:lite-execute", "optional": false }
      ],
      "cli_hints": {
        "explore_phase": { "tool": "gemini", "mode": "analysis", "trigger": "needs_exploration" },
        "execution": { "tool": "codex", "mode": "write", "trigger": "complexity >= medium" }
      },
      "estimated_time": "15-45 min"
    },
    "full": {
      "name": "Full Exploration",
      "description": "头脑风暴 + 规划 + 执行",
      "complexity": ["medium", "high"],
      "steps": [
        { "command": "/workflow:brainstorm:auto-parallel", "optional": false, "confirm_before": true },
        { "command": "/workflow:plan", "optional": false },
        { "command": "/workflow:action-plan-verify", "optional": true, "auto_continue": true },
        { "command": "/workflow:execute", "optional": false }
      ],
      "cli_hints": {
        "role_analysis": { "tool": "gemini", "mode": "analysis", "trigger": "always", "parallel": true },
        "execution": { "tool": "codex", "mode": "write", "trigger": "task_count >= 3" }
      },
      "estimated_time": "1-3 hours"
    },
    "coupled": {
      "name": "Coupled Planning",
      "description": "完整规划 + 验证 + 执行",
      "complexity": ["high"],
      "steps": [
        { "command": "/workflow:plan", "optional": false },
        { "command": "/workflow:action-plan-verify", "optional": false, "auto_continue": true },
        { "command": "/workflow:execute", "optional": false },
        { "command": "/workflow:review", "optional": true }
      ],
      "cli_hints": {
        "pre_analysis": { "tool": "gemini", "mode": "analysis", "trigger": "always" },
        "execution": { "tool": "codex", "mode": "write", "trigger": "always" }
      },
      "estimated_time": "2-4 hours"
    },
    "bugfix": {
      "name": "Bug Fix",
      "description": "智能诊断 + 修复",
      "complexity": ["low", "medium"],
      "variants": {
        "standard": [{ "command": "/workflow:lite-fix", "optional": false }],
        "hotfix": [{ "command": "/workflow:lite-fix --hotfix", "optional": false }]
      },
      "cli_hints": {
        "diagnosis": { "tool": "gemini", "mode": "analysis", "trigger": "always" },
        "fix": { "tool": "codex", "mode": "write", "trigger": "severity >= medium" }
      },
      "estimated_time": "10-30 min"
    },
    "issue": {
      "name": "Issue Lifecycle",
      "description": "发现积累 → 批量规划 → 队列优化 → 并行执行",
      "complexity": ["medium", "high"],
      "phases": {
        "accumulation": {
          "description": "项目迭代中持续发现和积累issue",
          "commands": ["/issue:discover", "/issue:new"],
          "trigger": "post-task, code-review, test-failure"
        },
        "resolution": {
          "description": "集中规划和执行积累的issue",
          "steps": [
            { "command": "/issue:plan --all-pending", "optional": false },
            { "command": "/issue:queue", "optional": false },
            { "command": "/issue:execute", "optional": false }
          ]
        }
      },
      "cli_hints": {
        "discovery": { "tool": "gemini", "mode": "analysis", "trigger": "perspective_analysis", "parallel": true },
        "solution_generation": { "tool": "gemini", "mode": "analysis", "trigger": "always", "parallel": true },
        "batch_execution": { "tool": "codex", "mode": "write", "trigger": "always" }
      },
      "estimated_time": "1-4 hours"
    },
    "lite-lite-lite": {
      "name": "Ultra-Lite Multi-CLI",
      "description": "零文件 + 自动CLI选择 + 语义描述 + 直接执行",
      "complexity": ["low", "medium"],
      "steps": [
        { "phase": "clarify", "description": "需求澄清 (AskUser if needed)" },
        { "phase": "auto-select", "description": "任务分析 → 自动选择CLI组合" },
        { "phase": "multi-cli", "description": "并行多CLI分析" },
        { "phase": "decision", "description": "展示结果 → AskUser决策" },
        { "phase": "execute", "description": "直接执行 (无中间文件)" }
      ],
      "vs_multi_cli_plan": {
        "artifacts": "None vs IMPL_PLAN.md + plan.json + synthesis.json",
        "session": "Stateless vs Persistent",
        "cli_selection": "Auto-select based on task analysis vs Config-driven",
        "iteration": "Via AskUser vs Via rounds/synthesis",
        "execution": "Direct vs Via lite-execute",
        "best_for": "Quick fixes, simple features vs Complex multi-step implementations"
      },
      "cli_hints": {
        "analysis": { "tool": "auto", "mode": "analysis", "parallel": true },
        "execution": { "tool": "auto", "mode": "write" }
      },
      "estimated_time": "10-30 min"
    },
    "multi-cli-plan": {
      "name": "Multi-CLI Collaborative Planning",
      "description": "ACE上下文 + 多CLI协作分析 + 迭代收敛 + 计划生成",
      "complexity": ["medium", "high"],
      "steps": [
        { "command": "/workflow:multi-cli-plan", "optional": false, "phases": [
          "context_gathering: ACE语义搜索",
          "multi_cli_discussion: cli-discuss-agent多轮分析",
          "present_options: 展示解决方案",
          "user_decision: 用户选择",
          "plan_generation: cli-lite-planning-agent生成计划"
        ]},
        { "command": "/workflow:lite-execute", "optional": false }
      ],
      "vs_lite_plan": {
        "context": "ACE semantic search vs Manual file patterns",
        "analysis": "Multi-CLI cross-verification vs Single-pass planning",
        "iteration": "Multiple rounds until convergence vs Single round",
        "confidence": "High (consensus-based) vs Medium (single perspective)",
        "best_for": "Complex tasks needing multiple perspectives vs Straightforward implementations"
      },
      "agents": ["cli-discuss-agent", "cli-lite-planning-agent"],
      "cli_hints": {
        "discussion": { "tools": ["gemini", "codex", "claude"], "mode": "analysis", "parallel": true },
        "planning": { "tool": "gemini", "mode": "analysis" }
      },
      "output": ".workflow/.multi-cli-plan/{session-id}/",
      "estimated_time": "30-90 min"
    },
    "tdd": {
      "name": "Test-Driven Development",
      "description": "TDD规划 + 执行 + 验证",
      "complexity": ["medium", "high"],
      "steps": [
        { "command": "/workflow:tdd-plan", "optional": false },
        { "command": "/workflow:execute", "optional": false },
        { "command": "/workflow:tdd-verify", "optional": false }
      ],
      "cli_hints": {
        "test_strategy": { "tool": "gemini", "mode": "analysis", "trigger": "always" },
        "red_green_refactor": { "tool": "codex", "mode": "write", "trigger": "always" }
      },
      "estimated_time": "1-3 hours"
    },
    "ui": {
      "name": "UI-First Development",
      "description": "UI设计 + 规划 + 执行",
      "complexity": ["medium", "high"],
      "variants": {
        "explore": [
          { "command": "/workflow:ui-design:explore-auto", "optional": false },
          { "command": "/workflow:ui-design:design-sync", "optional": false, "auto_continue": true },
          { "command": "/workflow:plan", "optional": false },
          { "command": "/workflow:execute", "optional": false }
        ],
        "imitate": [
          { "command": "/workflow:ui-design:imitate-auto", "optional": false },
          { "command": "/workflow:ui-design:design-sync", "optional": false, "auto_continue": true },
          { "command": "/workflow:plan", "optional": false },
          { "command": "/workflow:execute", "optional": false }
        ]
      },
      "estimated_time": "2-4 hours"
    },
    "review-fix": {
      "name": "Review and Fix",
      "description": "多维审查 + 自动修复",
      "complexity": ["medium"],
      "steps": [
        { "command": "/workflow:review-session-cycle", "optional": false },
        { "command": "/workflow:review-fix", "optional": true }
      ],
      "cli_hints": {
        "multi_dimension_review": { "tool": "gemini", "mode": "analysis", "trigger": "always", "parallel": true },
        "auto_fix": { "tool": "codex", "mode": "write", "trigger": "findings_count >= 3" }
      },
      "estimated_time": "30-90 min"
    },
    "docs": {
      "name": "Documentation",
      "description": "批量文档生成",
      "complexity": ["low", "medium"],
      "variants": {
        "incremental": [{ "command": "/memory:update-related", "optional": false }],
        "full": [
          { "command": "/memory:docs", "optional": false },
          { "command": "/workflow:execute", "optional": false }
        ]
      },
      "estimated_time": "15-60 min"
    }
  },

  "intent_rules": {
    "bugfix": {
      "priority": 1,
      "variants": {
        "hotfix": {
          "patterns": ["hotfix", "urgent", "production", "critical", "emergency", "紧急", "生产环境", "线上"],
          "flow": "bugfix.hotfix"
        },
        "standard": {
          "patterns": ["fix", "bug", "error", "issue", "crash", "broken", "fail", "wrong", "修复", "错误", "崩溃"],
          "flow": "bugfix.standard"
        }
      }
    },
    "issue_batch": {
      "priority": 2,
      "patterns": {
        "batch": ["issues", "batch", "queue", "多个", "批量"],
        "action": ["fix", "resolve", "处理", "解决"]
      },
      "require_both": true,
      "flow": "issue"
    },
    "exploration": {
      "priority": 3,
      "patterns": ["不确定", "不知道", "explore", "研究", "分析一下", "怎么做", "what if", "探索"],
      "flow": "full"
    },
    "ui_design": {
      "priority": 4,
      "patterns": ["ui", "界面", "design", "设计", "component", "组件", "style", "样式", "layout", "布局"],
      "variants": {
        "imitate": { "triggers": ["参考", "模仿", "像", "类似"], "flow": "ui.imitate" },
        "explore": { "triggers": [], "flow": "ui.explore" }
      }
    },
    "tdd": {
      "priority": 5,
      "patterns": ["tdd", "test-driven", "测试驱动", "先写测试", "test first"],
      "flow": "tdd"
    },
    "review": {
      "priority": 6,
      "patterns": ["review", "审查", "检查代码", "code review", "质量检查"],
      "flow": "review-fix"
    },
    "documentation": {
      "priority": 7,
      "patterns": ["文档", "documentation", "docs", "readme"],
      "variants": {
        "incremental": { "triggers": ["更新", "增量"], "flow": "docs.incremental" },
        "full": { "triggers": ["全部", "完整"], "flow": "docs.full" }
      }
    },
    "feature": {
      "priority": 99,
      "complexity_map": {
        "high": "coupled",
        "medium": "rapid",
        "low": "rapid"
      }
    }
  },

  "complexity_indicators": {
    "high": {
      "threshold": 4,
      "patterns": {
        "architecture": { "keywords": ["refactor", "重构", "migrate", "迁移", "architect", "架构", "system", "系统"], "weight": 2 },
        "multi_module": { "keywords": ["multiple", "多个", "across", "跨", "all", "所有", "entire", "整个"], "weight": 2 },
        "integration": { "keywords": ["integrate", "集成", "api", "database", "数据库"], "weight": 1 },
        "quality": { "keywords": ["security", "安全", "performance", "性能", "scale", "扩展"], "weight": 1 }
      }
    },
    "medium": { "threshold": 2 },
    "low": { "threshold": 0 }
  },

  "cli_tools": {
    "gemini": {
      "strengths": ["超长上下文", "深度分析", "架构理解", "执行流追踪"],
      "triggers": ["分析", "理解", "设计", "架构", "诊断"],
      "mode": "analysis"
    },
    "qwen": {
      "strengths": ["代码模式识别", "多维度分析"],
      "triggers": ["评估", "对比", "验证"],
      "mode": "analysis"
    },
    "codex": {
      "strengths": ["精确代码生成", "自主执行"],
      "triggers": ["实现", "重构", "修复", "生成"],
      "mode": "write"
    }
  },

  "cli_injection_rules": {
    "context_gathering": { "trigger": "file_read >= 50k OR module_count >= 5", "inject": "gemini --mode analysis" },
    "pre_planning_analysis": { "trigger": "complexity === high", "inject": "gemini --mode analysis" },
    "debug_diagnosis": { "trigger": "intent === bugfix AND root_cause_unclear", "inject": "gemini --mode analysis" },
    "code_review": { "trigger": "step === review", "inject": "gemini --mode analysis" },
    "implementation": { "trigger": "step === execute AND task_count >= 3", "inject": "codex --mode write" }
  },

  "artifact_flow": {
    "_description": "定义工作流产出的格式、意图提取和流转规则",

    "outputs": {
      "/workflow:lite-plan": {
        "artifact": "memory://plan",
        "format": "structured_plan",
        "fields": ["tasks", "files", "dependencies", "approach"]
      },
      "/workflow:plan": {
        "artifact": ".workflow/{session}/IMPL_PLAN.md",
        "format": "markdown_plan",
        "fields": ["phases", "tasks", "dependencies", "risks", "test_strategy"]
      },
      "/workflow:multi-cli-plan": {
        "artifact": ".workflow/.multi-cli-plan/{session}/",
        "format": "multi_file",
        "files": ["IMPL_PLAN.md", "plan.json", "synthesis.json"],
        "fields": ["consensus", "divergences", "recommended_approach", "tasks"]
      },
      "/workflow:lite-execute": {
        "artifact": "git_changes",
        "format": "code_diff",
        "fields": ["modified_files", "added_files", "deleted_files", "build_status"]
      },
      "/workflow:execute": {
        "artifact": ".workflow/{session}/execution_log.json",
        "format": "execution_report",
        "fields": ["completed_tasks", "pending_tasks", "errors", "warnings"]
      },
      "/workflow:test-cycle-execute": {
        "artifact": ".workflow/{session}/test_results.json",
        "format": "test_report",
        "fields": ["pass_rate", "failures", "coverage", "duration"]
      },
      "/workflow:review-session-cycle": {
        "artifact": ".workflow/{session}/review_report.md",
        "format": "review_report",
        "fields": ["findings", "severity_counts", "recommendations"]
      },
      "/workflow:lite-fix": {
        "artifact": "git_changes",
        "format": "fix_report",
        "fields": ["root_cause", "fix_applied", "files_modified", "verification_status"]
      }
    },

    "intent_extraction": {
      "plan_to_execute": {
        "from": ["lite-plan", "plan", "multi-cli-plan"],
        "to": ["lite-execute", "execute"],
        "extract": {
          "tasks": "$.tasks[] | filter(status != 'completed')",
          "priority_order": "$.tasks | sort_by(priority)",
          "files_to_modify": "$.tasks[].files | flatten | unique",
          "dependencies": "$.dependencies",
          "context_summary": "$.approach OR $.recommended_approach"
        }
      },
      "execute_to_test": {
        "from": ["lite-execute", "execute"],
        "to": ["test-cycle-execute", "test-fix-gen"],
        "extract": {
          "modified_files": "$.modified_files",
          "test_scope": "infer_from($.modified_files)",
          "build_status": "$.build_status",
          "pending_verification": "$.completed_tasks | needs_test"
        }
      },
      "test_to_fix": {
        "from": ["test-cycle-execute"],
        "to": ["lite-fix", "review-fix"],
        "condition": "$.pass_rate < 0.95",
        "extract": {
          "failures": "$.failures",
          "error_messages": "$.failures[].message",
          "affected_files": "$.failures[].file",
          "suggested_fixes": "$.failures[].suggested_fix"
        }
      },
      "review_to_fix": {
        "from": ["review-session-cycle", "review-module-cycle"],
        "to": ["review-fix"],
        "condition": "$.severity_counts.critical > 0 OR $.severity_counts.high > 3",
        "extract": {
          "findings": "$.findings | filter(severity in ['critical', 'high'])",
          "fix_priority": "$.findings | group_by(category) | sort_by(severity)",
          "affected_files": "$.findings[].file | unique"
        }
      }
    },

    "completion_criteria": {
      "plan": {
        "required": ["has_tasks", "has_files"],
        "optional": ["has_tests", "no_blocking_risks"],
        "threshold": 0.8,
        "routing": {
          "complete": "proceed_to_execute",
          "incomplete": "clarify_requirements"
        }
      },
      "execute": {
        "required": ["all_tasks_attempted", "no_critical_errors"],
        "optional": ["build_passes", "lint_passes"],
        "threshold": 1.0,
        "routing": {
          "complete": "proceed_to_test_or_review",
          "partial": "continue_execution",
          "failed": "diagnose_and_retry"
        }
      },
      "test": {
        "metrics": {
          "pass_rate": { "target": 0.95, "minimum": 0.80 },
          "coverage": { "target": 0.80, "minimum": 0.60 }
        },
        "routing": {
          "pass_rate >= 0.95 AND coverage >= 0.80": "complete",
          "pass_rate >= 0.95 AND coverage < 0.80": "add_more_tests",
          "pass_rate >= 0.80": "fix_failures_then_continue",
          "pass_rate < 0.80": "major_fix_required"
        }
      },
      "review": {
        "metrics": {
          "critical_findings": { "target": 0, "maximum": 0 },
          "high_findings": { "target": 0, "maximum": 3 }
        },
        "routing": {
          "critical == 0 AND high <= 3": "complete_or_optional_fix",
          "critical > 0": "mandatory_fix",
          "high > 3": "recommended_fix"
        }
      }
    },

    "flow_decisions": {
      "_description": "根据产出完成度决定下一步",
      "patterns": {
        "plan_execute_test": {
          "sequence": ["plan", "execute", "test"],
          "on_test_fail": {
            "action": "extract_failures_and_fix",
            "max_iterations": 3,
            "fallback": "manual_intervention"
          }
        },
        "plan_execute_review": {
          "sequence": ["plan", "execute", "review"],
          "on_review_issues": {
            "action": "prioritize_and_fix",
            "auto_fix_threshold": "severity < high"
          }
        },
        "iterative_improvement": {
          "sequence": ["execute", "test", "fix"],
          "loop_until": "pass_rate >= 0.95 OR iterations >= 3",
          "on_loop_exit": "report_status"
        }
      }
    }
  }
}
